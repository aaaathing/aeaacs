{% extends 'base.html' %}
{% block content %}

<style>
    /* Style for the chat history entries */
    .list-group-item {
        position: relative;
    }

    /* Style for the delete button */
    .delete-button {
        position: absolute;
        top: 5px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 1.2em;
        color: #888;
        cursor: pointer;
        outline: none;
    }

    /* Hover effect for the delete button */
    .delete-button:hover {
        color: #e74c3c;
        /* Change color on hover */
    }

    #question {
        height: 345px;
    }
</style>

<div class="row">
    <div class="col-3">
        <h3>Previous Answers</h3>
        <div id="previous-answers" class="list-group"></div>
        <!-- Delete Chat History Button -->
        <button class="btn btn-danger mt-3" onclick="deleteChatHistory()">Delete Chat History</button>
    </div>
    <div class="col">
        <p>
            Username: {{ current_user.username }}
            <a href="/edit">Edit info</a>
        </p>

        <form action="/logout" method="POST">
            <button class="btn btn-danger">Sign out</button>
        </form>

        <hr>

        <button class="btn btn-primary" onclick="introduce()">Introduce Yourself</button><br>

        <hr>

        <h1>Ask a Question</h1>

        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label for="question">Question:</label>
                    <textarea id="question" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="col" style="display: flex; align-items: center;">
                <div>
                    <button id="recordButton" class="btn btn-secondary mb-3">Record Question</button>
                    <span id="recording"></span><br>

                    <form id="answer-options">
                        <!-- Verbosity Options -->
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="verbosity" id="concise" value="concise"
                                checked>
                            <label class="form-check-label" for="concise">Concise</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="verbosity" id="verbose" value="verbose">
                            <label class="form-check-label" for="verbose">Verbose</label>
                        </div>
                        <br>

                        <!-- Tone Options -->
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tone" id="casual" value="casual" checked>
                            <label class="form-check-label" for="casual">Casual</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tone" id="funny" value="funny">
                            <label class="form-check-label" for="funny">Funny</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tone" id="professional"
                                value="professional">
                            <label class="form-check-label" for="professional">Professional</label>
                        </div>
                    </form>

                    <button class="btn btn-primary mb-3 mt-3" onclick="answer()">Generate Answers</button><br>
                    <button class="btn btn-success mb-3" onclick="answer('yes')">Generate Answers for Yes</button><br>
                    <button class="btn btn-danger mb-3" onclick="answer('no')">Generate Answers for No</button><br>
                    <button class="btn btn-warning mb-3" onclick="answer('maybe')">Generate Answers for Maybe</button><br>
                </div>
            </div>
        </div>

        <h2 class="mt-4">Suggested Answers</h2>
        <div id="answers" class="list-group"></div>
    </div>
</div>

<script>
    async function answer(whatYouWantToSay) {
        let formData = new FormData();
        let question = document.querySelector("#question").value.trim();
        if (!question) {
            alert("Please enter a question.");
            return;
        }
        let form = document.querySelector("#answer-options")
        formData.append("question", question);
        formData.append("verbosity", form.elements.verbosity.value);
        formData.append("tone", form.elements.tone.value);
        formData.append("whatYouWantToSay", whatYouWantToSay);
        let response = await fetch("/api/send_text", { method: "POST", body: formData });
        let answers = await response.json();
        if (answers.success) {
            document.querySelector("#answers").innerHTML = answers.answers.reduce((a, answer) => a + `
                <button class="list-group-item list-group-item-action" onclick="speak(this.textContent); sendText(this)">
                    ${removeBad(answer)}
                </button>
            `, "");
        } else {
            alert("Error fetching answers.");
        }
    }
    function speak(what) {
        let utterance = new SpeechSynthesisUtterance(what);
        speechSynthesis.speak(utterance);
    }

    async function sendText(button) {
        let formData = new FormData();
        let question = document.querySelector("#question").value;
        let chosenAnswer = button.textContent;
        formData.append("question", question);
        formData.append("chosen_answer", chosenAnswer);
        let response = await fetch("/api/save_answer", { method: "POST", body: formData });
        let data = await response.json();
        if (data.success) {
            // Prepend the new answer to the previous answers list
            addPreviousAnswer({
                answer_id: data.answer_id,
                question: question,
                chosen_answer: chosenAnswer
            });
            // Clear the suggested answers
            document.querySelector("#answers").innerHTML = '';
            // Optionally, clear the question textarea
            document.querySelector("#question").value = '';
        } else {
            alert("Error saving the answer.");
        }
    }

    function addPreviousAnswer(answer) {
        document.querySelector("#previous-answers")
            .insertAdjacentHTML("afterbegin", `
            <div class="list-group-item" data-answer-id="${removeBad(answer.answer_id)}" onclick="speak(this.textContent)">
                <button class="delete-button" onclick="deleteAnswer('${removeBad(answer.answer_id)}')">&times;</button>
                <strong>${removeBad(answer.question)}</strong><br>
                ${removeBad(answer.chosen_answer)}
            </div>
        `);
    }

    fetch("/api/previous_answers").then(r => r.json()).then(answers => {
        document.querySelector("#previous-answers")
            .innerHTML = answers.reduce((a, answer) => a + `
            <div class="list-group-item" data-answer-id="${removeBad(answer.answer_id)}" onclick="speak(this.textContent)">
                <button class="delete-button" onclick="deleteAnswer('${removeBad(answer.answer_id)}')">&times;</button>
                <strong>${removeBad(answer.question)}</strong><br>
                ${removeBad(answer.chosen_answer)}
            </div>
            `, "");
    });

    async function deleteAnswer(answerId) {
        if (confirm("Are you sure you want to delete this entry?")) {
            let formData = new FormData();
            formData.append("answer_id", answerId);
            let response = await fetch('/api/delete_answer', {
                method: 'POST',
                body: formData
            });
            let data = await response.json();
            if (data.success) {
                // Remove the answer from the UI
                let answerElement = document.querySelector(`[data-answer-id='${answerId}']`);
                if (answerElement) {
                    answerElement.remove();
                }
            } else {
                alert(data.message);
            }
        }
    }

    async function deleteChatHistory() {
        if (confirm("Are you sure you want to delete all your chat history? This action cannot be undone.")) {
            let response = await fetch('/api/delete_chat_history', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            let data = await response.json();
            if (data.success) {
                alert(data.message);
                // Clear the previous answers list
                document.querySelector("#previous-answers").innerHTML = '';
            } else {
                alert('Error deleting chat history.');
            }
        }
    }

    let recordButton = document.querySelector("#recordButton");
    let recording = document.querySelector("#recording");
    function startRecord() {
        let recognition = new (window.webkitSpeechRecognition || SpeechRecognition)();
        recordButton.onclick = function () {
            recordButton.onclick = startRecord;
            recordButton.textContent = "Record question";
            recording.textContent = ""
            recognition.stop();
        }
        recordButton.textContent = "Stop Recording";
        recording.textContent = "Recording..."
        recognition.onresult = function (e) {
            let result = "";
            for (let r of e.results) result += r[0].transcript + "\n";
            document.querySelector("#question").value = result;
        }
        recognition.start();
    }
    recordButton.onclick = startRecord;

    async function introduce(){
        let info = await (await fetch("/api/get_user_info")).json()
        speak(info.introduction)
    }

    function removeBad(str) {
        return str.replace(/[<>]/g, function (c) { return { '<': '&lt;', '>': '&gt;' }[c] });
    }
</script>

{% endblock %}
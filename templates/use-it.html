{% extends 'base.html' %}
{% block content %}

<style>
    /* Style for the chat history entries */
    .list-group-item {
        position: relative;
    }

    /* Style for the delete button */
    .delete-button {
        position: absolute;
        top: 5px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 1.2em;
        color: #888;
        cursor: pointer;
        outline: none;
    }

    /* Hover effect for the delete button */
    .delete-button:hover {
        color: #e74c3c; /* Change color on hover */
    }
</style>

<div class="row">
    <div class="col-3">
        <h3>Previous Answers</h3>
        <div id="previous-answers" class="list-group"></div>
        <!-- Delete Chat History Button -->
        <button class="btn btn-danger mt-3" onclick="deleteChatHistory()">Delete Chat History</button>
    </div>
    <div class="col">
        <p>
            Username: {{ current_user.username }}
            <a href="/edit">Edit info</a>
        </p>

        <form action="/logout" method="POST">
            <button class="btn btn-danger">Sign out</button>
        </form>

        <hr>

        <h1>Ask a Question</h1>

        <div class="form-group">
            <label for="question">Question:</label>
            <textarea id="question" class="form-control" rows="3"></textarea>
        </div>
        <button class="btn btn-primary" onclick="answer()">Get Answers</button>
        <button id="recordButton" class="btn btn-secondary">Start Recording</button>

        <h2 class="mt-4">Suggested Answers</h2>
        <div id="answers" class="list-group"></div>
    </div>
</div>

<script>
    async function answer() {
        let formData = new FormData();
        let question = document.querySelector("#question").value.trim();
        if (!question) {
            alert("Please enter a question.");
            return;
        }
        formData.append("question", question);
        let response = await fetch("/api/send_text", { method: "POST", body: formData });
        let answers = await response.json();
        if (answers.success) {
            document.querySelector("#answers").innerHTML = answers.answers.reduce((a, answer) => a + `
                <button class="list-group-item list-group-item-action" onclick="sendText(this)">
                    ${removeBad(answer)}
                </button>
            `, "");
        } else {
            alert("Error fetching answers.");
        }
    }

    async function sendText(button) {
        let formData = new FormData();
        let question = document.querySelector("#question").value;
        let chosenAnswer = button.textContent;
        formData.append("question", question);
        formData.append("chosen_answer", chosenAnswer);
        let response = await fetch("/api/save_answer", { method: "POST", body: formData });
        let data = await response.json();
        if (data.success) {
            // Prepend the new answer to the previous answers list
            addPreviousAnswer({
                answer_id: data.answer_id,
                question: question,
                chosen_answer: chosenAnswer
            });
            // Clear the suggested answers
            document.querySelector("#answers").innerHTML = '';
            // Optionally, clear the question textarea
            document.querySelector("#question").value = '';
        } else {
            alert("Error saving the answer.");
        }
    }

    function addPreviousAnswer(answer) {
        document.querySelector("#previous-answers")
            .insertAdjacentHTML("afterbegin", `
            <div class="list-group-item" data-answer-id="${removeBad(answer.answer_id)}">
                <button class="delete-button" onclick="deleteAnswer('${removeBad(answer.answer_id)}')">&times;</button>
                <strong>${removeBad(answer.question)}</strong><br>
                ${removeBad(answer.chosen_answer)}
            </div>
        `);
    }

    fetch("/api/previous_answers").then(r => r.json()).then(answers => {
        document.querySelector("#previous-answers")
            .innerHTML = answers.reduce((a, answer) => a + `
            <div class="list-group-item" data-answer-id="${removeBad(answer.answer_id)}">
                <button class="delete-button" onclick="deleteAnswer('${removeBad(answer.answer_id)}')">&times;</button>
                <strong>${removeBad(answer.question)}</strong><br>
                ${removeBad(answer.chosen_answer)}
            </div>
            `, "");
    });

    async function deleteAnswer(answerId) {
        if (confirm("Are you sure you want to delete this entry?")) {
            let formData = new FormData();
            formData.append("answer_id", answerId);
            let response = await fetch('/api/delete_answer', {
                method: 'POST',
                body: formData
            });
            let data = await response.json();
            if (data.success) {
                // Remove the answer from the UI
                let answerElement = document.querySelector(`[data-answer-id='${answerId}']`);
                if (answerElement) {
                    answerElement.remove();
                }
            } else {
                alert(data.message);
            }
        }
    }

    async function deleteChatHistory() {
        if (confirm("Are you sure you want to delete all your chat history? This action cannot be undone.")) {
            let response = await fetch('/api/delete_chat_history', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            let data = await response.json();
            if (data.success) {
                alert(data.message);
                // Clear the previous answers list
                document.querySelector("#previous-answers").innerHTML = '';
            } else {
                alert('Error deleting chat history.');
            }
        }
    }

    let recordButton = document.querySelector("#recordButton");
    function startRecord() {
        let recognition = new (window.webkitSpeechRecognition || SpeechRecognition)();
        recordButton.onclick = function () {
            recordButton.onclick = startRecord;
            recordButton.textContent = "Start Recording";
            recognition.stop();
        }
        recordButton.textContent = "Stop Recording";
        recognition.onresult = function (e) {
            let result = "";
            for (let r of e.results) result += r[0].transcript + "\n";
            document.querySelector("#question").value = result;
        }
        recognition.start();
    }
    recordButton.onclick = startRecord;

    function removeBad(str) {
        return str.replace(/[<>]/g, function (c) { return { '<': '&lt;', '>': '&gt;' }[c] });
    }
</script>

{% endblock %}
